<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Quotation Builder — Full</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f4f4f9; --fg:#222; --muted:#666; --card:#fff; --pri:#0b5fff; --pri-d:#0848c7; --accent:#06b6d4; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; background:var(--bg); color:var(--fg); }
    .container { max-width:1200px; margin:28px auto; padding:20px; background:var(--card); border-radius:14px; box-shadow:0 12px 40px rgba(2,6,23,.08); }
    header { display:flex; justify-content:space-between; align-items:center; gap:16px; }
    h1 { margin:0; font-size:22px; }
    .sub { color:var(--muted); margin:8px 0 18px; }
    .steps { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px; }
    .pill { padding:8px 12px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:13px; }
    .step { display:none; }
    .step.active { display:block; }
    .grid { display:grid; gap:16px; }
    .cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .card { padding:16px; border:1px solid #e8eef7; border-radius:12px; background:linear-gradient(180deg,#fff,#fbfdff); box-shadow:0 4px 16px rgba(11,95,255,.03); }
    .card h3 { margin:0 0 10px; font-size:16px; color:var(--accent); }
    label { display:block; margin:6px 0; color:#333; font-size:13px; }
    input[type="text"], input[type="number"], select, textarea { width:100%; padding:10px 12px; border:1px solid #e2e8f0; border-radius:8px; background:#fff; }
    input[type="file"] { padding:10px; border:1px dashed #cbd5e1; border-radius:8px; background:#fafafa; width:100%; }
    .row { display:flex; gap:12px; align-items:center; }
    .row > * { flex:1; }
    .buttons { display:flex; justify-content:space-between; gap:12px; margin-top:16px; }
    button { appearance:none; border:none; background:var(--pri); color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; box-shadow:0 6px 18px rgba(11,95,255,.08); }
    button.secondary { background:#eef2ff; color:var(--pri); border:1px solid #e6f0ff; }
    button.ghost { background:transparent; color:var(--pri); border:1px dashed #cfe6ff; }
    button:hover { filter:brightness(.95); transform:translateY(-1px); }
    .hint { color:var(--muted); font-size:13px; margin-top:6px; }
    .stack { display:flex; flex-direction:column; gap:8px; }
    .checks { max-height:260px; overflow:auto; border:1px solid #eef2f6; padding:10px; border-radius:8px; background:#fcfeff; }
    .checks label { display:flex; gap:8px; align-items:center; margin:4px 0; font-size:14px; }
    .section-title { font-size:14px; font-weight:700; margin:8px 0; color:#0b5fff; }

    /* review styles */
    .review-toolbar { display:flex; justify-content:space-between; gap:12px; align-items:center; margin-bottom:12px; }
    .review-area { display:grid; gap:16px; grid-template-columns: 1fr 380px; }
    .review-left, .review-right { padding:12px; border-radius:10px; background:#fff; border:1px solid #eef5ff; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { border-bottom:1px solid #f1f5f9; padding:8px 6px; text-align:left; vertical-align:middle; }
    th { background:linear-gradient(90deg,#fbfdff,#f5fbff); color:#0b4bcc; font-weight:700; }
    .numCell { width:140px; text-align:right; }
    .editable { background:#fffbe6; border:1px dashed #ffe58f; padding:6px 8px; border-radius:6px; min-width:60px; text-align:right; }
    .muted { color:var(--muted); font-size:13px; }
    .summary { font-size:15px; font-weight:700; color:#0b5fff; text-align:right; }
    .small { font-size:12px; color:var(--muted); }
    .badge { display:inline-block; padding:6px 8px; border-radius:8px; font-weight:700; background:#eef2ff; color:#0b5fff; font-size:13px; }
    .section-subtotal { font-weight:700; text-align:right; padding-top:8px; }
    .pdfButton { margin-left:8px; }
  </style>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Quotation Builder</h1>
        <div class="sub">Upload your workbook. This tool reads the Transfers & Sites sheets dynamically, calculates and shows an editable review, and exports a styled PDF.</div>
      </div>
      <div class="muted small">Client-only (SheetJS + pdfmake)</div>
    </header>

    <div class="steps" aria-hidden>
      <span class="pill">1) Upload & Sites</span>
      <span class="pill">2) Accommodation</span>
      <span class="pill">3) Meals & Guides</span>
      <span class="pill">4) Trips & Export</span>
      <span class="pill">5) Review & Edit</span>
    </div>

    <!-- STEP 1 -->
    <section id="step1" class="step active">
      <div class="grid cols-2">
        <div class="card">
          <h3>Upload Excel (.xlsx)</h3>
          <input type="file" id="upload" accept=".xlsx" />
          <div class="hint">We will parse the workbook and use the Transfers & Sites sheets dynamically.</div>
        </div>
        <div class="card">
          <h3>Quotation Info</h3>
          <div class="stack">
            <label>Quotation Name <input id="quotationName" type="text" placeholder="e.g. Smith Family Tour" /></label>
            <label>Flight Ticket (EGP total — editable in review) <input id="flightTicket" type="number" inputmode="numeric" placeholder="e.g. 12000" /></label>
          </div>
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:16px;">
        <div class="card">
          <h3>Pyramids</h3>
          <div class="checks" id="cbPyramids"></div>
        </div>
        <div class="card">
          <h3>Sakkara</h3>
          <div class="checks" id="cbSakkara"></div>
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:16px;">
        <div class="card">
          <h3>Cairo/Giza</h3>
          <div class="checks" id="cbCairoGiza"></div>
        </div>
        <div class="card">
          <h3>Alexandria/Behera</h3>
          <div class="checks" id="cbAlexBehera"></div>
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:16px;">
        <div class="card">
          <h3>Kafr el Sheikh / Sharkia / Minya / Sohag / Qena</h3>
          <div class="checks" id="cbKafrEtAl"></div>
        </div>
        <div class="card">
          <h3>Luxor</h3>
          <div class="checks" id="cbLuxor"></div>
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:16px;">
        <div class="card">
          <h3>Aswan</h3>
          <div class="checks" id="cbAswan"></div>
        </div>
        <div class="card">
          <h3>Sharm el Sheikh</h3>
          <div class="checks" id="cbSharm"></div>
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:16px;">
        <div class="card">
          <h3>Mosques</h3>
          <div class="checks" id="cbMosques"></div>
        </div>
      </div>

      <div class="buttons">
        <button class="secondary" id="resetBtn1" type="button">Reset</button>
        <button id="toStep2" type="button">Next → Accommodation</button>
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="step2" class="step">
      <div class="grid cols-2">
        <div class="card">
          <h3>Cairo/Giza</h3>
          <div class="row">
            <label>Nights
              <select id="ddlNightsCairoGiza"></select>
            </label>
            <label>Price/Night (USD)
              <select id="ddlPriceCairoGiza"></select>
            </label>
          </div>
        </div>
        <div class="card">
          <h3>Sharm el Sheikh</h3>
          <div class="row">
            <label>Nights
              <select id="ddlNightsSharm"></select>
            </label>
            <label>Price/Night (USD)
              <select id="ddlPriceSharm"></select>
            </label>
          </div>
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:16px;">
        <div class="card">
          <h3>Luxor</h3>
          <div class="row">
            <label>Nights
              <select id="ddlNightsLuxor"></select>
            </label>
            <label>Price/Night (USD)
              <select id="ddlPriceLuxor"></select>
            </label>
          </div>
        </div>
        <div class="card">
          <h3>Aswan</h3>
          <div class="row">
            <label>Nights
              <select id="ddlNightsAswan"></select>
            </label>
            <label>Price/Night (USD)
              <select id="ddlPriceAswan"></select>
            </label>
          </div>
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:16px;">
        <div class="card">
          <h3>Hurghada</h3>
          <div class="row">
            <label>Nights
              <select id="ddlNightsHurghada"></select>
            </label>
            <label>Price/Night (USD)
              <select id="ddlPriceHurghada"></select>
            </label>
          </div>
        </div>
        <div class="card">
          <h3>Nile Cruise</h3>
          <div class="row">
            <label>Nights
              <select id="ddlNightsNileCruise"></select>
            </label>
            <label>Price/Night (USD)
              <select id="ddlPriceNileCruise"></select>
            </label>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3>Controls used by formulas</h3>
        <div class="row">
          <label>Number of Pax (E3) — override workbook E3 if given:
            <input id="numPax" type="number" min="1" placeholder="leave blank to use workbook E3" />
          </label>
          <label>Quote Date (J2) — override workbook J2 if given:
            <input id="quoteDate" type="date" />
          </label>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>Exchange Rate (M2) — local currency → USD (divide local / rate). Default 47.7
            <input id="exchangeRate" type="number" step="0.01" value="47.7" />
          </label>
          <label style="align-self:center; font-size:12px; color:var(--muted)">Site & transfer prices are treated as EGP and converted to USD for totals.</label>
        </div>
      </div>

      <div class="buttons">
        <button class="secondary" id="back1" type="button">← Back</button>
        <button id="toStep3" type="button">Next → Meals & Guides</button>
      </div>
    </section>

    <!-- STEP 3 -->
    <section id="step3" class="step">
      <div class="grid cols-3">
        <div class="card">
          <h3>Guide Ticket (EGP)</h3>
          <input id="TextBoxGuideTicket" type="number" inputmode="numeric" placeholder="EGP" />
        </div>
        <div class="card">
          <h3>Guide Accommodation (EGP)</h3>
          <input id="TextBoxGuideAccomodation" type="number" inputmode="numeric" placeholder="EGP" />
        </div>
        <div class="card">
          <h3>Meals per Price Tier (EGP)</h3>
          <div class="stack" id="mealsSelects"></div>
        </div>
      </div>

      <div class="buttons">
        <button class="secondary" id="back2" type="button">← Back</button>
        <button id="toStep4" type="button">Next → Trips & Export</button>
      </div>
    </section>

    <!-- STEP 4 -->
    <section id="step4" class="step">
      <div class="grid cols-3">
        <div class="card">
          <h3>Cairo/Giza Counters</h3>
          <label>Cairo apt
            <select id="Cairoapt"></select>
          </label>
          <label>Cairo Full Day
            <select id="Cairofd"></select>
          </label>
          <label>Cairo Night
            <select id="CairoNight"></select>
          </label>
        </div>

        <div class="card">
          <h3>Cairo/Giza Trips</h3>
          <div class="checks" id="cbCairoGizaTrips"></div>
        </div>

        <div class="card">
          <h3>Sharm Trips</h3>
          <div class="checks" id="cbSharmTrips"></div>
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:16px;">
        <div class="card">
          <h3>Luxor Trips</h3>
          <div class="checks" id="cbLuxorTrips"></div>
        </div>
        <div class="card">
          <h3>Aswan Trips</h3>
          <div class="checks" id="cbAswanTrips"></div>
        </div>
      </div>

      <div class="buttons">
        <button class="secondary" id="back3" type="button">← Back</button>
        <button id="downloadBtn" type="button">Show Review & Edit</button>
      </div>
    </section>

    <!-- STEP 5: Review & Edit -->
    <section id="step5" class="step" aria-live="polite">
      <div class="card">
        <div class="review-toolbar">
          <div>
            <span class="badge">Review & Edit</span>
            <span id="reviewQuoteTitle" class="muted"></span>
          </div>
          <div>
            <button class="secondary" id="backToSteps">← Back to steps</button>
            <button id="applyEdits" class="ghost">Apply Edits to State</button>
            <button id="downloadPdf" class="secondary pdfButton">Download PDF</button>
          </div>
        </div>

        <div class="review-area">
          <div class="review-left" id="reviewLeft">
            <h3 style="margin-top:0">Detail Rows (Rows 10 → 40)</h3>
            <div id="detailTables"></div>
          </div>

          <div class="review-right" id="reviewRight">
            <h3 style="margin-top:0">Summary</h3>
            <div id="reviewSummary" class="summary">Computing...</div>
            <div style="height:12px"></div>
            <div class="small muted">Editable fields are yellow and represent EGP (except accommodation totals which are USD). Totals are computed in USD.</div>
            <div style="height:12px"></div>
            <div id="sectionSubtotals" class="small"></div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <script>
  // ---------- Utilities ----------
  const $ = sel => document.querySelector(sel);
  function optionRange(sel, from, to, withZero=false){
    sel.innerHTML="";
    if(withZero){ const z=document.createElement('option'); z.value="0"; z.text="0"; sel.appendChild(z); }
    for(let i=from;i<=to;i++){ const o=document.createElement('option'); o.value=String(i); o.text=String(i); sel.appendChild(o); }
  }
  function renderChecks(container, items){
    const el=document.querySelector(container); el.innerHTML="";
    items.forEach(txt=>{
      const id = container.slice(1) + "_" + txt.replace(/\W+/g,'_');
      const lbl=document.createElement('label');
      const cb = document.createElement('input'); cb.type='checkbox'; cb.value=txt; cb.id=id;
      const span=document.createElement('span'); span.textContent=" "+txt;
      lbl.appendChild(cb); lbl.appendChild(span);
      el.appendChild(lbl);
    });
  }
  function getChecked(container){ return Array.from(document.querySelectorAll(container+" input[type=checkbox]:checked")).map(cb=>cb.value); }
  function parseNumber(v){ if(v===null||v===undefined) return null; const s=String(v).toString().replace(/,/g,'').trim(); if(s==="") return null; const n=Number(s); return Number.isFinite(n)?n:null; }
  function roundTo(n, dec=2){ if(n===null||n===undefined||n==="") return ""; return Math.round((Number(n) + Number.EPSILON) * Math.pow(10,dec))/Math.pow(10,dec); }
  function fmt(n, dec=2){ if(n===null||n===undefined||n==="") return ""; // drop trailing zeros intelligently
    const r = roundTo(Number(n), dec);
    return Number.isFinite(r) ? r.toLocaleString('en-US', {minimumFractionDigits: (dec===0?0: (Math.abs(r - Math.round(r)) > 0 ? 2 : 0)), maximumFractionDigits: dec}) : "";
  }
  function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // ---------- Static lists ----------
  const lists = {
    Pyramids: ["Pyramids","Khufu Pyramid","Khafra Pyramid","Menkaure Pyramid","Grave of Mer As Ankh"],
    Sakkara: ["Memphis","Sakkara","Nobles Cemetery","South Cemetery","All Sakkara","Zoser Pyramid (Inside)","Serapeum Sakkara","Mereruka"],
    CairoGiza: ["Grand Egyptian Museum","Citadel","Egyptian Museum","Civilization Museum","Egyptian Museum (Guide)","Islamic Art Museum","Coptic Museum","Royal Carriage Museum","Gayer Anderson Museum","Senosert Obelisk","Baron Palace","Moez Street","Mohammed Ali Manial Palace","Nilometer","Rifa'i Mosque","Suhaymi House","Mohamed Ali Palace"],
    AlexBehera: ["Qaitbay","Montazah","Alexandria Library","Kom al Shuqafa","Kom al Dekka","Serapeum Alexandria","Alexandria Museum","Royal Jewellery Museum","Graeco-Roman Museum","Rashid City"],
    KafrEtAl: ["Abydoss","Dandara","Kafr El Sheikh Museum","San Al Hajar","Malwi Museum","Tona El Gabal","Bani Hassan Cemetery","Tal Al Omrana","Royal Cemetery Al Omrana","Meret Amon/Ramses II Statue"],
    Luxor: ["Karnak","Luxor Museum","Hot Air Balloon","Luxor Temple","Valley of Kings","Seti I Cemetery","Ay Cemetery","Hatshepsut","Der Al Madina","Pashtu Cemetery","Ra'muza Cemetery","Alramseum Temple","Abdel Karna","Carter House","Menena Nakht","Seti I Temple","Osraht - Khensu","ElAssassif","Esna","Tutankhamun Cemetery","Ramses VI","Habo","Valley of Queens","Nefertari","Khokha","Shuroy","Qurnet Murai","Abdel Karna Necropolis","Mummification","Mut (Karnak)"],
    Aswan: ["Abu Simbel","Unfinished Obelisk","Philae","Edfu","Kom Ombo","Nubian Museum","High Dam","Qubet Al Hawa","Al Kalabsha","AlKab","Abu Simbel Celebration"],
    Sharm: ["Parasailing","Jet Ski","Banana Boat","King tut Mus","Submarine","St Catherine","Neverland without dinner","Neverland with dinner","Dolphin","Sea Trip","Dinner Cruise","Quad Bike","Sharm Museum","Aqua Park"],
    Mosques: ["Al Bahnasa","Al Azhar Mosque","Imam Al Hussein","Sheikh Zayed Al Kawthari","Luqman Al Hakim","Desouqi Mosque","Imam Ahmed El Badawy","Imam Shafi","Sayed Sakina","Sayeda Ruqayya","El Sayeda Nafisa","Al Ezz bin Abdul Salam","Kamal Ibn Hammam","Ibn Atta Allah Al Sakandary"],

    CairoGizaTrips: ["Cairo hd","Cairo fd October","Cairo apt + fd","Cairo open day","Alex fd","Ain sukhna","Cairo apt October","Sphinx apt","Sphinx apt fd","New capital apt","New capital apt fd","Quick Alex","Quick Sukhna","Minya","Oasis","Fayoum","Wadi Rayan","Zafarana","Farafra","Hurghada","Matrouh","Ras Sedr","Sharm","Dahab","Luxor","Aswan","Tanta","On"],
    SharmTrips: ["Dep SSH","Arr SSH","Transfer Hotel SSH","City Tour SSH","City Tour SSH","City Tour SSH","City Tour SSH","City Tour SSH","Dep + Arr APT Cairo - SSH","Ras Mohamed Half Day ( SSH )","Ras Mohamed Full Day ( SSH )","St Catherine","St Catherine Moses","Cairo One Way ( SSH )","Orientation Dahab Full Day (Vehicle From Dahab)","Orientation Dahab Half Day (Vehicle From Dahab)","Dahab Jeep Safari ( SSH )","DAHAB ZAVYOT - SSH","Dahab ( Nuweiba ) Adventure"],
    LuxorTrips: ["Luxor Station","East","West Fd","West","Dandara","Dandara Abydoss","Hurghada Luxor","Luxor apt"],
    AswanTrips: ["Aswan Station","Aswan apt","Aswan fd","Nubian Museum","Abu Simbel","Nubian Village","Nubian Village Visit"]
  };

  // ---------- Render checkboxes and selects ----------
  renderChecks('#cbPyramids', lists.Pyramids);
  renderChecks('#cbSakkara', lists.Sakkara);
  renderChecks('#cbCairoGiza', lists.CairoGiza);
  renderChecks('#cbAlexBehera', lists.AlexBehera);
  renderChecks('#cbKafrEtAl', lists.KafrEtAl);
  renderChecks('#cbLuxor', lists.Luxor);
  renderChecks('#cbAswan', lists.Aswan);
  renderChecks('#cbSharm', lists.Sharm);
  renderChecks('#cbMosques', lists.Mosques);
  renderChecks('#cbCairoGizaTrips', lists.CairoGizaTrips);
  renderChecks('#cbSharmTrips', lists.SharmTrips);
  renderChecks('#cbLuxorTrips', lists.LuxorTrips);
  renderChecks('#cbAswanTrips', lists.AswanTrips);

  const nightsIds = ['ddlNightsCairoGiza','ddlNightsSharm','ddlNightsLuxor','ddlNightsAswan','ddlNightsHurghada','ddlNightsNileCruise'];
  nightsIds.forEach(id => optionRange(document.getElementById(id), 0, 10, false));
  const priceUSDExamples = [0,30,40,50,60,70,80,90,100,110,120,130,140,150,200,250];
  const priceNileCruise = [0,100,110,120,130,140,150,160,170,180,190,200,210,220,230,240,250,300,350,400];
  function fillPrice(selId, arr){ const el=document.getElementById(selId); el.innerHTML=""; arr.forEach(v=>{const o=document.createElement('option'); o.value=String(v); o.text=String(v); el.appendChild(o);}); }
  fillPrice('ddlPriceCairoGiza', priceUSDExamples);
  fillPrice('ddlPriceSharm', priceUSDExamples);
  fillPrice('ddlPriceLuxor', priceUSDExamples);
  fillPrice('ddlPriceAswan', priceUSDExamples);
  fillPrice('ddlPriceHurghada', priceUSDExamples);
  fillPrice('ddlPriceNileCruise', priceNileCruise);

  // meals dropdowns (EGP prices)
  const mealTiers = ["300","400","500","600","700","800","900","1000","1500","2000"];
  const mealsWrap = document.getElementById('mealsSelects');
  mealTiers.forEach(tier=>{
    const row=document.createElement('div'); row.className='row';
    const lbl=document.createElement('label'); lbl.textContent=`${tier} Meals (qty)`;
    const sel=document.createElement('select'); sel.id='ddlMeals'+tier;
    optionRange(sel, 0, 6, false);
    row.appendChild(lbl); row.appendChild(sel);
    mealsWrap.appendChild(row);
  });

  // cairo counters
  optionRange(document.getElementById('Cairoapt'), 0, 5, false);
  optionRange(document.getElementById('Cairofd'), 0, 5, false);
  optionRange(document.getElementById('CairoNight'), 0, 5, false);

  // ---------- appState ----------
  const appState = {
    workbook: null,
    sheetName: null,
    quotationName: "",
    flightTicket: "", // EGP numeric total — editable later
    sites: [],
    accommodation: { "Cairo/Giza": {nights:"0", price:"0"}, "Sharm el Sheikh": {nights:"0", price:"0"}, "Luxor": {nights:"0", price:"0"}, "Aswan": {nights:"0", price:"0"}, "Hurghada": {nights:"0", price:"0"}, "Nile Cruise": {nights:"0", price:"0"} },
    guideTicket: "", // EGP
    guideAccomodation: "", // EGP
    meals: { "300":"0","400":"0","500":"0","600":"0","700":"0","800":"0","900":"0","1000":"0","1500":"0","2000":"0" },
    cairoCounters: { apt:"0", fd:"0", night:"0" },
    trips: { "CairoGiza": [], "Sharm": [], "Luxor": [], "Aswan": [] },
    lookups: { sites: {}, transfers: {} },
    preview: { rows: [], accommodationRows: [], mealRows: [], summaryTotal: 0, subtotals: {} }
  };

  // ---------- Excel upload and parse ----------
  $('#upload').addEventListener('change', e=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = evt=>{
      try {
        const data = new Uint8Array(evt.target.result);
        appState.workbook = XLSX.read(data, { type:'array' });
        appState.sheetName = appState.workbook.SheetNames[0];
        parseLookupsFromWorkbook();
        // populate UI defaults from workbook E3/J2 if present
        const wbE3 = readCellA1(appState.sheetName,'E3');
        if(parseNumber(wbE3)!==null) $('#numPax').value = parseNumber(wbE3);
        const wbJ2 = readCellA1(appState.sheetName,'J2');
        if(wbJ2){
          let d;
          if(wbJ2 instanceof Date) d = wbJ2.toISOString().slice(0,10);
          else if(typeof wbJ2 === 'number'){ const parsed = XLSX.SSF.parse_date_code(wbJ2); if(parsed) d = new Date(parsed.y, parsed.m-1, parsed.d).toISOString().slice(0,10); }
          else { const dt = new Date(wbJ2); if(!isNaN(dt)) d = dt.toISOString().slice(0,10); }
          if(d) $('#quoteDate').value = d;
        }
        alert('Workbook read and lookups parsed.');
      } catch(err){ console.error(err); alert('Failed to read workbook.'); }
    };
    reader.readAsArrayBuffer(file);
  });

  function findSheetNameLike(sub){
    if(!appState.workbook) return null;
    const name = appState.workbook.SheetNames.find(n => n.toLowerCase().includes(sub.toLowerCase()));
    return name || null;
  }

  function parseLookupsFromWorkbook(){
    appState.lookups = { sites:{}, transfers:{} };

    const sitesSheet = findSheetNameLike('site') || findSheetNameLike('sites');
    if(sitesSheet){
      const sht = appState.workbook.Sheets[sitesSheet];
      const rows = XLSX.utils.sheet_to_json(sht, {header:1, raw:true});
      for(let r=1;r<rows.length;r++){
        const row = rows[r];
        if(!row || !row[0]) continue;
        const name = String(row[0]).trim();
        const before = parseNumber(row[1]) || 0;
        const after = (parseNumber(row[2])!==null) ? parseNumber(row[2]) : null;
        appState.lookups.sites[name] = { before, after };
      }
    } else console.warn('Sites sheet not found');

    const transfersSheet = findSheetNameLike('transfer') || findSheetNameLike('transfers');
    if(transfersSheet){
      const sht = appState.workbook.Sheets[transfersSheet];
      const rows = XLSX.utils.sheet_to_json(sht, {header:1, raw:true});
      for(let r=1;r<rows.length;r++){
        const row = rows[r];
        if(!row) continue;
        const nameBefore = row[0];
        const nameAfter = row[4];
        const name = (nameBefore || nameAfter);
        if(!name) continue;
        const beforeArr = [ parseNumber(row[1])||0, parseNumber(row[2])||0, parseNumber(row[3])||0 ];
        // after may be in cols 5..7 (index 5..7) — we attempt to get numeric or leave null
        const afterArr = [ parseNumber(row[5]) || null, parseNumber(row[6]) || null, parseNumber(row[7]) || null ];
        // If after arr entries are null, try to parse formulas / fallback — we'll leave as null for now.
        appState.lookups.transfers[String(name).trim()] = { before: beforeArr, after: afterArr };
      }
    } else console.warn('Transfers sheet not found');

    console.log('Parsed lookups:', appState.lookups);
  }

  function readCellA1(sheetName, a1){
    if(!appState.workbook || !sheetName) return null;
    const sht = appState.workbook.Sheets[sheetName];
    if(!sht) return null;
    const cell = sht[a1];
    if(!cell) return null;
    return cell.v !== undefined ? cell.v : null;
  }

  // ---------- Navigation handlers ----------
  $('#toStep2').addEventListener('click', ()=>{
    if(!appState.workbook){ alert('Upload workbook first'); return; }
    appState.quotationName = $('#quotationName').value.trim();
    if(!appState.quotationName){ alert('Please provide a Quotation Name.'); return; }
    appState.flightTicket = $('#flightTicket').value.trim();
    // collect sites
    appState.sites = []
      .concat(getChecked('#cbPyramids'))
      .concat(getChecked('#cbSakkara'))
      .concat(getChecked('#cbCairoGiza'))
      .concat(getChecked('#cbAlexBehera'))
      .concat(getChecked('#cbKafrEtAl'))
      .concat(getChecked('#cbLuxor'))
      .concat(getChecked('#cbAswan'))
      .concat(getChecked('#cbSharm'));
    showStep(2);
  });
  $('#back1').addEventListener('click', ()=> showStep(1));
  $('#toStep3').addEventListener('click', ()=>{
    appState.accommodation["Cairo/Giza"].nights = $('#ddlNightsCairoGiza').value;
    appState.accommodation["Cairo/Giza"].price  = $('#ddlPriceCairoGiza').value;
    appState.accommodation["Sharm el Sheikh"].nights = $('#ddlNightsSharm').value;
    appState.accommodation["Sharm el Sheikh"].price  = $('#ddlPriceSharm').value;
    appState.accommodation["Luxor"].nights = $('#ddlNightsLuxor').value;
    appState.accommodation["Luxor"].price  = $('#ddlPriceLuxor').value;
    appState.accommodation["Aswan"].nights = $('#ddlNightsAswan').value;
    appState.accommodation["Aswan"].price  = $('#ddlPriceAswan').value;
    appState.accommodation["Hurghada"].nights = $('#ddlNightsHurghada').value;
    appState.accommodation["Hurghada"].price  = $('#ddlPriceHurghada').value;
    appState.accommodation["Nile Cruise"].nights = $('#ddlNightsNileCruise').value;
    appState.accommodation["Nile Cruise"].price  = $('#ddlPriceNileCruise').value;
    showStep(3);
  });
  $('#back2').addEventListener('click', ()=> showStep(2));
  $('#toStep4').addEventListener('click', ()=>{
    appState.guideTicket = $('#TextBoxGuideTicket').value.trim();
    appState.guideAccomodation = $('#TextBoxGuideAccomodation').value.trim();
    mealTiers.forEach(tier => appState.meals[tier] = $('#ddlMeals'+tier).value);
    showStep(4);
  });
  $('#back3').addEventListener('click', ()=> showStep(3));
  $('#resetBtn1').addEventListener('click', ()=> { if(confirm('Clear all inputs?')) location.reload(); });

  // ---------- Keep original Excel writing (kept for parity) ----------
  function n(v){ const x=parseInt(v,10); return Number.isFinite(x) ? x : null; }
  function set(ws, addr, value){ ws[addr] = (typeof value === 'number') ? { t:'n', v:value } : { t:'s', v:String(value) }; }
  function ensureRef(ws,minA1,maxA1){ const dec = r=>XLSX.utils.decode_cell(r); const enc = o=>XLSX.utils.encode_cell(o); const min = dec(minA1), max = dec(maxA1); const cur = ws['!ref'] ? XLSX.utils.decode_range(ws['!ref']) : { s:{c:0,r:0}, e:{c:0,r:0}}; const s={ c: Math.min(cur.s.c,min.c), r: Math.min(cur.s.r,min.r)}; const e={ c: Math.max(cur.e.c,max.c), r: Math.max(cur.e.r,max.r) }; ws['!ref'] = XLSX.utils.encode_range({s,e}); }

  function writeExcelAndDownload(){ /* retained but not used in review UI */ }

  // ---------- Core: compute preview model (mirrors your Excel formula logic) ----------
  function computePreviewModel(){
    // reset
    appState.preview.rows = [];
    appState.preview.accommodationRows = [];
    appState.preview.mealRows = [];

    // pax: UI input overrides workbook E3
    const uiPax = parseNumber($('#numPax').value);
    const wbE3 = readCellA1(appState.sheetName, 'E3');
    const pax = uiPax || parseNumber(wbE3) || 2;

    // quote date: UI override > workbook J2 > today
    let qDate = null;
    const uiDate = $('#quoteDate').value;
    if(uiDate) qDate = new Date(uiDate);
    else {
      const wbJ2 = readCellA1(appState.sheetName,'J2');
      if(wbJ2 instanceof Date) qDate = wbJ2;
      else if(typeof wbJ2 === 'number'){ const parsed = XLSX.SSF.parse_date_code(wbJ2); if(parsed) qDate = new Date(parsed.y,parsed.m-1,parsed.d); }
      else if(typeof wbJ2 === 'string'){ const d=new Date(wbJ2); if(!isNaN(d)) qDate=d; }
    }
    if(!qDate) qDate = new Date();

    // exchange rate
    const exRate = parseNumber($('#exchangeRate').value) || 47.7;
    const thresholdDate = new Date(2025,10,1); // Nov 1, 2025

    // Accommodation rows: price is INPUT in USD (user asked)
    const accomOrder = ["Cairo/Giza","Sharm el Sheikh","Luxor","Aswan","Hurghada","Nile Cruise"];
    for(let i=0;i<accomOrder.length;i++){
      const place = accomOrder[i];
      const rowIndex = 10 + i;
      const nights = parseNumber(appState.accommodation[place].nights) || 0;
      const priceUSD = parseNumber(appState.accommodation[place].price) || 0; // USD per night
      const totalUSD = (nights>0 && priceUSD>0) ? roundTo(nights * priceUSD,2) : "";
      appState.preview.accommodationRows.push({ rowIndex, place, nights, priceUSD, totalUSD });
    }

    // Meals: EGP -> convert to USD (but user wants meal entries in EGP displayed)
    let mealRowIndex=10;
    for(const tier of mealTiers){
      const qty = parseNumber(appState.meals[tier]) || 0;
      if(qty>0){
        const totalEGP = qty * Number(tier);
        const totalUSD = roundTo(totalEGP / exRate,2);
        appState.preview.mealRows.push({ rowIndex: mealRowIndex, tier:Number(tier), qty, totalEGP, totalUSD });
        mealRowIndex++;
      }
    }

    // create rows 10..40
    const rows = [];
    for(let r=10;r<=40;r++){
      rows.push({ row:r, B:"", C_usd:"", C_local:"", D_usd:"", F:"", G_local:"", G_usd:"", H:"", I_local:"", I_usd:"", J:"", K_local:"", K_usd:"", L:"", M_local:"", M_usd:"" });
    }

    // fill accommodation rows into rows array (C_usd etc)
    for(const ac of appState.preview.accommodationRows){
      const idx = ac.rowIndex - 10;
      rows[idx].B = ac.nights>0 ? `${ac.nights} nights ${ac.place}` : ac.place;
      rows[idx].C_usd = ac.totalUSD === "" ? "" : ac.totalUSD;
      rows[idx].D_usd = (ac.totalUSD !== "" ? roundTo(ac.totalUSD * 0.7, 2) : "");
    }

    // fill J/K for meals
    for(const m of appState.preview.mealRows){
      const idx = m.rowIndex - 10;
      rows[idx].J = `${m.qty} x ${m.tier} meals`;
      rows[idx].K_local = m.totalEGP;
      rows[idx].K_usd = m.totalUSD;
    }

    // F/G: flight ticket (EGP) then site names (lookups in EGP converted to USD)
    const fList = [];
    const ftLocal = parseNumber(appState.flightTicket);
    if(ftLocal !== null && ftLocal !== "") fList.push({ label: 'Flight Ticket', local: ftLocal });
    for(const s of appState.sites) fList.push({ label: s, local: null });

    for(let i=0;i<fList.length;i++){
      const rowIndex = 10 + i;
      if(rowIndex>40) break;
      const entry = fList[i];
      rows[rowIndex - 10].F = entry.label;
      if(entry.label === 'Flight Ticket'){
        rows[rowIndex - 10].G_local = entry.local !== null ? entry.local : "";
        rows[rowIndex - 10].G_usd = (entry.local!==null && entry.local!=="") ? roundTo(entry.local / exRate,2) : "";
      } else {
        const sl = appState.lookups.sites[entry.label];
        if(sl){
          const useAfter = (qDate >= thresholdDate);
          const priceLocal = useAfter ? (sl.after !== null ? sl.after : sl.before) : sl.before;
          rows[rowIndex - 10].G_local = (priceLocal!==null && priceLocal!==undefined) ? priceLocal : "";
          rows[rowIndex - 10].G_usd = (priceLocal!=="" ? roundTo(priceLocal / exRate,2) : "");
        } else {
          rows[rowIndex - 10].G_local = "";
          rows[rowIndex - 10].G_usd = "";
        }
      }
    }

    // H/I transfers list: build according to counters and checked trips
    const hList = [];
    const cntApt = parseNumber(appState.cairoCounters.apt) || 0;
    for(let i=0;i<cntApt;i++) hList.push('Cairo apt');
    const cntFd = parseNumber(appState.cairoCounters.fd) || 0;
    for(let i=0;i<cntFd;i++) hList.push('Cairo fd');
    const cntNight = parseNumber(appState.cairoCounters.night) || 0;
    for(let i=0;i<cntNight;i++) hList.push('Cairo night');
    hList.push(...(appState.trips.CairoGiza||[]));
    hList.push(...(appState.trips.Sharm||[]));
    hList.push(...(appState.trips.Luxor||[]));
    hList.push(...(appState.trips.Aswan||[]));

    for(let i=0;i<hList.length;i++){
      const rowIndex = 10 + i;
      if(rowIndex>40) break;
      const name = hList[i];
      rows[rowIndex - 10].H = name;
      const tr = appState.lookups.transfers[name];
      if(!tr){ rows[rowIndex - 10].I_local = ""; rows[rowIndex - 10].I_usd = ""; continue; }
      const useAfter = (qDate >= thresholdDate);
      const arr = useAfter ? (tr.after.map(v=>v===null?0:v)) : tr.before;
      const idx = (pax <= 7 ? 0 : (pax <= 15 ? 1 : 2));
      const localValue = arr[idx] || 0;
      // transfer per-pax local value = localValue / pax
      const perPersonLocal = (pax>0 ? roundTo(localValue / pax, 2) : 0);
      rows[rowIndex - 10].I_local = perPersonLocal;
      rows[rowIndex - 10].I_usd = roundTo(perPersonLocal / exRate, 2);
    }

    // guide ticket and guide accom: show as separate lines (we'll put into rows 12 and 13 like original)
    const guideTicketLocal = parseNumber(appState.guideTicket);
    if(guideTicketLocal !== null){
      const idx = 12 - 10;
      rows[idx].F = "Guide Ticket";
      rows[idx].G_local = guideTicketLocal;
      // divide by pax and convert to USD per spec
      const perPaxLocal = pax>0 ? roundTo(guideTicketLocal / pax, 2) : 0;
      rows[idx].G_usd = roundTo(perPaxLocal / (parseNumber($('#exchangeRate').value) || 47.7), 2);
      // also store M fields for clarity
      rows[idx].M_local = guideTicketLocal;
      rows[idx].M_usd = roundTo(guideTicketLocal / (parseNumber($('#exchangeRate').value) || 47.7) / pax, 2);
    }
    const guideAccLocal = parseNumber(appState.guideAccomodation);
    if(guideAccLocal !== null){
      const idx = 13 - 10;
      rows[idx].F = "Guide Accommodation";
      rows[idx].G_local = guideAccLocal;
      rows[idx].G_usd = roundTo(guideAccLocal / (parseNumber($('#exchangeRate').value) || 47.7), 2);
      rows[idx].M_local = guideAccLocal;
      rows[idx].M_usd = roundTo(guideAccLocal / (parseNumber($('#exchangeRate').value) || 47.7), 2);
    }

    appState.preview.rows = rows;

    // compute subtotals (USD)
    let subtotalAccommodation = 0;
    for(const a of appState.preview.accommodationRows) if(a.totalUSD!=="") subtotalAccommodation += Number(a.totalUSD);

    let subtotalSitesLocal = 0, subtotalSitesUSD=0;
    let subtotalTransfersUSD = 0, subtotalTransfersLocalTotal=0;
    let subtotalMealsLocal = 0, subtotalMealsUSD = 0;
    let subtotalGuideUSD = 0, subtotalGuideLocal = 0;

    rows.forEach(r=>{
      // sites: F present and not Flight Ticket and G_local present
      if(r.F && r.F !== "Flight Ticket" && parseNumber(r.G_local)!==null){
        subtotalSitesLocal += Number(r.G_local);
        subtotalSitesUSD += Number(r.G_usd || 0);
      }
      // flight ticket (EGP) included in sites group (if present)
      if(r.F && r.F === "Flight Ticket" && parseNumber(r.G_local)!==null){
        subtotalSitesLocal += Number(r.G_local);
        subtotalSitesUSD += Number(r.G_usd || 0);
      }
      if(r.I_usd && r.I_usd!=="") subtotalTransfersUSD += Number(r.I_usd);
      if(r.K_local && r.K_local!=="") subtotalMealsLocal += Number(r.K_local);
      if(r.K_usd && r.K_usd!=="") subtotalMealsUSD += Number(r.K_usd);
      if(r.M_usd && r.M_usd!=="") subtotalGuideUSD += Number(r.M_usd);
      if(r.M_local && r.M_local!=="") subtotalGuideLocal += Number(r.M_local);
    });

    subtotalAccommodation = roundTo(subtotalAccommodation,2);
    subtotalSitesUSD = roundTo(subtotalSitesUSD,2);
    subtotalTransfersUSD = roundTo(subtotalTransfersUSD,2);
    subtotalMealsUSD = roundTo(subtotalMealsUSD,2);
    subtotalGuideUSD = roundTo(subtotalGuideUSD,2);

    const grandTotalUSD = roundTo(subtotalAccommodation + subtotalSitesUSD + subtotalTransfersUSD + subtotalMealsUSD + subtotalGuideUSD, 2);

    appState.preview.summaryTotal = grandTotalUSD;
    appState.preview.subtotals = {
      accommodation: subtotalAccommodation,
      sites_usd: subtotalSitesUSD,
      transfers_usd: subtotalTransfersUSD,
      meals_usd: subtotalMealsUSD,
      guide_usd: subtotalGuideUSD,
      // for display of EGP divisions
      sites_local: roundTo(subtotalSitesLocal,2),
      transfers_local_total: roundTo(subtotalTransfersLocalTotal,2),
      meals_local: roundTo(subtotalMealsLocal,2),
      guide_local: roundTo(subtotalGuideLocal,2)
    };
  }

  // ---------- Render review page ----------
  function renderReviewPage(){
    $('#reviewQuoteTitle').textContent = appState.quotationName ? `— ${appState.quotationName}` : '';
    computePreviewModel();
    const rows = appState.preview.rows;
    const detailDiv = $('#detailTables');
    detailDiv.innerHTML = '';

    // Accommodation table
    const accomDiv = document.createElement('div');
    accomDiv.innerHTML = `<h4 class="small">Accommodation (rows 10→15)</h4>`;
    const t1 = document.createElement('table');
    t1.innerHTML = `<thead><tr><th>Row</th><th>Place</th><th class="numCell">Total (USD)</th><th class="numCell">Single Supplement (70%) (USD)</th></tr></thead>`;
    const b1 = document.createElement('tbody');
    appState.preview.accommodationRows.forEach(a=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${a.rowIndex}</td>
        <td>${escapeHtml(a.place)} <div class="small muted">nights: ${a.nights} @ ${fmt(a.priceUSD)} (USD/night)</div></td>
        <td class="numCell"><input class="editable" data-path="accom:${a.place}:total" data-row="${a.rowIndex}" value="${a.totalUSD!==""?a.totalUSD:''}"></td>
        <td class="numCell">${a.totalUSD!==""?fmt(roundTo(a.totalUSD*0.7,2)):""}</td>`;
      b1.appendChild(tr);
    });
    t1.appendChild(b1); accomDiv.appendChild(t1); detailDiv.appendChild(accomDiv);

    // Sites & Flight Tickets (EGP editable display, USD subtotal shown in right)
    const fDiv = document.createElement('div'); fDiv.innerHTML = `<h4 class="small">Sites & Flight Tickets (EGP values — editable)</h4>`;
    const t2 = document.createElement('table');
    t2.innerHTML = `<thead><tr><th>Row</th><th>Label (F)</th><th class="numCell">Value (EGP)</th><th class="numCell">Value (USD)</th></tr></thead>`;
    const b2 = document.createElement('tbody');
    rows.forEach(r=>{
      if(r.F && r.F !== ""){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.row}</td>
          <td>${escapeHtml(r.F)}</td>
          <td class="numCell"><input class="editable" data-path="F_local:${r.row}" data-row="${r.row}" value="${r.G_local!==""?r.G_local:''}" /></td>
          <td class="numCell">${r.G_usd!==""?fmt(r.G_usd):''}</td>`;
        b2.appendChild(tr);
      }
    });
    t2.appendChild(b2); fDiv.appendChild(t2); detailDiv.appendChild(fDiv);

    // Transfers table (EGP per transfer shown; displayed per pax; editable EGP)
    const trDiv = document.createElement('div'); trDiv.innerHTML = `<h4 class="small">Transfers (EGP shown — per pax; editable). Transfers subtotal used per-pax in USD total.</h4>`;
    const t3 = document.createElement('table');
    t3.innerHTML = `<thead><tr><th>Row</th><th>Transfer (H)</th><th class="numCell">Price per pax (EGP)</th><th class="numCell">Price per pax (USD)</th></tr></thead>`;
    const b3 = document.createElement('tbody');
    rows.forEach(r=>{
      if(r.H && r.H !== ""){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.row}</td>
          <td>${escapeHtml(r.H)}</td>
          <td class="numCell"><input class="editable" data-path="H_local:${r.row}" data-row="${r.row}" value="${r.I_local!==""?r.I_local:''}" /></td>
          <td class="numCell">${r.I_usd!==""?fmt(r.I_usd):''}</td>`;
        b3.appendChild(tr);
      }
    });
    t3.appendChild(b3); trDiv.appendChild(t3); detailDiv.appendChild(trDiv);

    // Meals table (EGP qty and local total editable)
    const mealDiv = document.createElement('div'); mealDiv.innerHTML = `<h4 class="small">Meals (EGP values — editable)</h4>`;
    const t4 = document.createElement('table');
    t4.innerHTML = `<thead><tr><th>Row</th><th>Label (J)</th><th class="numCell">Total (EGP)</th><th class="numCell">Total (USD)</th></tr></thead>`;
    const b4 = document.createElement('tbody');
    rows.forEach(r=>{
      if(r.J && r.J !== ""){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.row}</td><td>${escapeHtml(r.J)}</td><td class="numCell"><input class="editable" data-path="J_local:${r.row}" data-row="${r.row}" value="${r.K_local!==""?r.K_local:''}" /></td><td class="numCell">${r.K_usd!==""?fmt(r.K_usd):''}</td>`;
        b4.appendChild(tr);
      }
    });
    t4.appendChild(b4); mealDiv.appendChild(t4); detailDiv.appendChild(mealDiv);

    // Guide (separate display)
    const guideDiv = document.createElement('div'); guideDiv.innerHTML = `<h4 class="small">Guide (EGP values)</h4>`;
    const tg = document.createElement('table');
    tg.innerHTML = `<thead><tr><th>Row</th><th>Item</th><th class="numCell">Value (EGP)</th><th class="numCell">Value (USD)</th></tr></thead>`;
    const bg = document.createElement('tbody');
    rows.forEach(r=>{
      if((r.F && (r.F==="Guide Ticket" || r.F==="Guide Accommodation")) || r.M_local){
        if(r.F && r.F==="Guide Ticket"){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r.row}</td><td>Guide Ticket (EGP total)</td><td class="numCell"><input class="editable" data-path="guide_local:${r.row}" data-row="${r.row}" value="${r.G_local!==""?r.G_local:''}" /></td><td class="numCell">${r.G_usd!==""?fmt(r.G_usd):''}</td>`;
          bg.appendChild(tr);
        }
        if(r.F && r.F==="Guide Accommodation"){
          const tr2 = document.createElement('tr');
          tr2.innerHTML = `<td>${r.row}</td><td>Guide Accommodation (EGP)</td><td class="numCell"><input class="editable" data-path="guideacc_local:${r.row}" data-row="${r.row}" value="${r.G_local!==""?r.G_local:''}" /></td><td class="numCell">${r.G_usd!==""?fmt(r.G_usd):''}</td>`;
          bg.appendChild(tr2);
        }
      }
    });
    tg.appendChild(bg); guideDiv.appendChild(tg); detailDiv.appendChild(guideDiv);

    // Summary and subtotals
    $('#reviewSummary').textContent = `Grand total (USD): $ ${fmt(appState.preview.summaryTotal)}`;
    const subs = appState.preview.subtotals;
    $('#sectionSubtotals').innerHTML = `
      <div class="small">Accommodation subtotal (USD): <strong>$ ${fmt(subs.accommodation)}</strong></div>
      <div class="small">Sites subtotal (USD): <strong>$ ${fmt(subs.sites_usd)}</strong></div>
      <div class="small">Transfers subtotal (USD, per pax): <strong>$ ${fmt(subs.transfers_usd)}</strong></div>
      <div class="small">Meals subtotal (USD): <strong>$ ${fmt(subs.meals_usd)}</strong></div>
      <div class="small">Guide subtotal (USD): <strong>$ ${fmt(subs.guide_usd)}</strong></div>
      <div style="height:6px"></div>
      <div class="small">Single Supplement (70% of accommodation, USD): <strong>$ ${fmt(roundTo(subs.accommodation * 0.7,2))}</strong></div>
    `;

    // Wire editable inputs — user edits EGP fields (except accom which is USD)
    Array.from(detailDiv.querySelectorAll('input.editable')).forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const path = inp.dataset.path;
        const rowNum = Number(inp.dataset.row);
        const valRaw = inp.value.trim();
        const val = parseNumber(valRaw);
        if(path.startsWith('F_local:')){ // Sites or Flight Ticket EGP
          const rowObj = appState.preview.rows.find(x=>x.row===rowNum);
          if(rowObj){ rowObj.G_local = (val===null? "": val); rowObj.G_usd = (val===null? "": roundTo(val / (parseNumber($('#exchangeRate').value) || 47.7),2)); }
        } else if(path.startsWith('H_local:')){ // transfers per pax EGP
          const rowObj = appState.preview.rows.find(x=>x.row===rowNum);
          if(rowObj){ rowObj.I_local = (val===null? "": val); rowObj.I_usd = (val===null? "": roundTo(val / (parseNumber($('#exchangeRate').value) || 47.7),2)); }
        } else if(path.startsWith('J_local:')){ // meals local total EGP
          const rowObj = appState.preview.rows.find(x=>x.row===rowNum);
          if(rowObj){ rowObj.K_local = (val===null? "": val); rowObj.K_usd = (val===null? "": roundTo(val / (parseNumber($('#exchangeRate').value) || 47.7),2)); }
        } else if(path.startsWith('guide_local:')){
          const rowObj = appState.preview.rows.find(x=>x.row===rowNum);
          if(rowObj){ rowObj.G_local = (val===null? "": val); rowObj.G_usd = (val===null? "": roundTo((val / (parseNumber($('#exchangeRate').value) || 47.7) / (parseNumber($('#numPax').value) || parseNumber(readCellA1(appState.sheetName,'E3')) || 1)),2)); rowObj.M_local = rowObj.G_local; rowObj.M_usd = roundTo(val / (parseNumber($('#exchangeRate').value) || 47.7) / (parseNumber($('#numPax').value) || 1),2); }
        } else if(path.startsWith('guideacc_local:')){
          const rowObj = appState.preview.rows.find(x=>x.row===rowNum);
          if(rowObj){ rowObj.G_local = (val===null? "": val); rowObj.G_usd = (val===null? "": roundTo(val / (parseNumber($('#exchangeRate').value) || 47.7),2)); rowObj.M_local = rowObj.G_local; rowObj.M_usd = roundTo(val / (parseNumber($('#exchangeRate').value) || 47.7),2); }
        } else if(path.startsWith('accom:')){ // accommodation USD editable
          const rowIndex = Number(inp.dataset.row);
          const ac = appState.preview.accommodationRows.find(x=>x.rowIndex===rowIndex);
          if(ac){
            const newUSD = (val===null ? "" : val);
            ac.totalUSD = newUSD;
            // update rows model
            const rowObj = appState.preview.rows.find(x=>x.row===rowIndex);
            if(rowObj){ rowObj.C_usd = newUSD; rowObj.D_usd = (newUSD!=="" ? roundTo(newUSD * 0.7,2) : ""); }
          }
        }
        recomputeSummaryAndRender();
      });
    });

    showStep(5);
  }

  function recomputeSummaryAndRender(){
    // recompute subtotals and grand total with current preview values
    let subsAcc=0, subsSitesUSD=0, subsTransfersUSD=0, subsMealsUSD=0, subsGuideUSD=0;
    appState.preview.accommodationRows.forEach(a=>{ if(a.totalUSD!=="") subsAcc += Number(a.totalUSD); });
    appState.preview.rows.forEach(r=>{
      if(r.F && r.F !== "" && r.G_usd && r.G_usd!=="") subsSitesUSD += Number(r.G_usd);
      if(r.I_usd && r.I_usd!=="") subsTransfersUSD += Number(r.I_usd);
      if(r.K_usd && r.K_usd!=="") subsMealsUSD += Number(r.K_usd);
      if(r.M_usd && r.M_usd!=="") subsGuideUSD += Number(r.M_usd);
    });
    subsAcc = roundTo(subsAcc,2); subsSitesUSD = roundTo(subsSitesUSD,2); subsTransfersUSD = roundTo(subsTransfersUSD,2); subsMealsUSD = roundTo(subsMealsUSD,2); subsGuideUSD = roundTo(subsGuideUSD,2);
    const grand = roundTo(subsAcc + subsSitesUSD + subsTransfersUSD + subsMealsUSD + subsGuideUSD, 2);
    appState.preview.summaryTotal = grand;
    appState.preview.subtotals = { accommodation: subsAcc, sites_usd: subsSitesUSD, transfers_usd: subsTransfersUSD, meals_usd: subsMealsUSD, guide_usd: subsGuideUSD };
    $('#reviewSummary').textContent = `Grand total (USD): $ ${fmt(grand)}`;
    const subs = appState.preview.subtotals;
    $('#sectionSubtotals').innerHTML = `
      <div class="small">Accommodation subtotal (USD): <strong>$ ${fmt(subs.accommodation)}</strong></div>
      <div class="small">Sites subtotal (USD): <strong>$ ${fmt(subs.sites_usd)}</strong></div>
      <div class="small">Transfers subtotal (USD, per pax): <strong>$ ${fmt(subs.transfers_usd)}</strong></div>
      <div class="small">Meals subtotal (USD): <strong>$ ${fmt(subs.meals_usd)}</strong></div>
      <div class="small">Guide subtotal (USD): <strong>$ ${fmt(subs.guide_usd)}</strong></div>
      <div style="height:6px"></div>
      <div class="small">Single Supplement (70% of accommodation, USD): <strong>$ ${fmt(roundTo(subs.accommodation * 0.7,2))}</strong></div>
    `;
  }

  // ---------- Show Review button ----------
  $('#downloadBtn').addEventListener('click', ()=>{
    appState.cairoCounters.apt = $('#Cairoapt').value;
    appState.cairoCounters.fd = $('#Cairofd').value;
    appState.cairoCounters.night = $('#CairoNight').value;
    appState.trips.CairoGiza = getChecked('#cbCairoGizaTrips');
    appState.trips.Sharm = getChecked('#cbSharmTrips');
    appState.trips.Luxor = getChecked('#cbLuxorTrips');
    appState.trips.Aswan = getChecked('#cbAswanTrips');
    renderReviewPage();
  });

  $('#backToSteps').addEventListener('click', ()=> showStep(4));

  // ---------- Apply edits button: writes any accommodation USD edits back into the form (price per night) ----------
  $('#applyEdits').addEventListener('click', ()=>{
    let changes = 0;
    const exRate = parseNumber($('#exchangeRate').value) || 47.7;
    appState.preview.accommodationRows.forEach(ac=>{
      const rowsRow = appState.preview.rows.find(x=>x.row===ac.rowIndex);
      const newUSD = parseNumber(ac.totalUSD);
      if(newUSD !== null && ac.nights>0){
        // compute new price per night USD
        const newPriceUSD = roundTo(newUSD / ac.nights, 2);
        appState.accommodation[ac.place].price = String(newPriceUSD);
        changes++;
      }
    });
    alert(`Applied edits: updated ${changes} accommodation prices (USD/night) in the form.`);
    // reflect in selects (add option if necessary)
    const map = {
      'ddlPriceCairoGiza':'Cairo/Giza',
      'ddlPriceSharm':'Sharm el Sheikh',
      'ddlPriceLuxor':'Luxor',
      'ddlPriceAswan':'Aswan',
      'ddlPriceHurghada':'Hurghada',
      'ddlPriceNileCruise':'Nile Cruise'
    };
    Object.keys(map).forEach(id=>{
      const place = map[id];
      const sel = document.getElementById(id);
      if(!sel) return;
      const newVal = appState.accommodation[place].price;
      if(newVal === undefined) return;
      let opt = Array.from(sel.options).find(o => o.value === String(newVal));
      if(!opt){
        opt = document.createElement('option'); opt.value = String(newVal); opt.text = String(newVal);
        sel.appendChild(opt);
      }
      sel.value = String(newVal);
    });
    computePreviewModel();
    renderReviewPage();
  });

  // ---------- PDF generation (pdfmake) ----------
  $('#downloadPdf').addEventListener('click', ()=>{
    computePreviewModel();
    const subs = appState.preview.subtotals;
    const rows = appState.preview.rows;

    // Build content: header, accommodation table (USD), then sections with EGP detail and USD subtotal, then totals
    const docDef = {
      pageSize: 'A4',
      pageMargins: [40, 60, 40, 60],
      content: [
        { text: 'Quotation', style: 'header' },
        { text: appState.quotationName || 'Quotation', style: 'subheader' },
        { text: `Date: ${ ( ($('#quoteDate').value) ? $('#quoteDate').value : (new Date()).toISOString().slice(0,10) ) }`, margin:[0,0,0,8] },
        { text: 'Accommodation (USD)', style: 'sectionTitle' },
        {
          table: {
            widths: ['auto', '*', 'auto'],
            body: [
              [{ text:'Row', bold:true }, { text:'Place / nights', bold:true }, { text:'Total (USD)', bold:true }]
            ].concat(appState.preview.accommodationRows.map(a=>[ String(a.rowIndex), `${a.place} — ${a.nights} nights`, a.totalUSD===""? "-" : fmt(a.totalUSD) ]))
          }
        },
        { text: '\nSites & Flight Tickets (EGP details, USD subtotal)', style: 'sectionTitle' },
        {
          table: {
            widths: ['auto','*','auto','auto'],
            body: [
              [{text:'Row',bold:true},{text:'Label',bold:true},{text:'Amount (EGP)',bold:true},{text:'Amount (USD)',bold:true}]
            ].concat(rows.filter(r=>r.F && r.F!=="").map(r=>[ String(r.row), r.F, (r.G_local===""? "-" : fmt(r.G_local)), (r.G_usd===""? "-" : fmt(r.G_usd)) ]))
          }
        },
        { text: '\nTransfers (EGP per pax displayed; subtotal per pax applied in USD)', style: 'sectionTitle' },
        {
          table: {
            widths: ['auto','*','auto','auto'],
            body: [
              [{text:'Row',bold:true},{text:'Transfer',bold:true},{text:'EGP per pax',bold:true},{text:'USD per pax',bold:true}]
            ].concat(rows.filter(r=>r.H && r.H!=="").map(r=>[ String(r.row), r.H, (r.I_local===""? "-" : fmt(r.I_local)), (r.I_usd===""? "-" : fmt(r.I_usd)) ]))
          }
        },
        { text: '\nMeals (EGP, USD converted)', style: 'sectionTitle' },
        {
          table: {
            widths: ['auto','*','auto','auto'],
            body: [
              [{text:'Row',bold:true},{text:'Label',bold:true},{text:'EGP',bold:true},{text:'USD',bold:true}]
            ].concat(rows.filter(r=>r.J && r.J!=="").map(r=>[ String(r.row), r.J, (r.K_local===""? "-" : fmt(r.K_local)), (r.K_usd===""? "-" : fmt(r.K_usd)) ]) )
          }
        },
        { text: '\nGuide', style: 'sectionTitle' },
        {
          table: {
            widths: ['auto','*','auto','auto'],
            body: [
              [{text:'Row',bold:true},{text:'Item',bold:true},{text:'EGP',bold:true},{text:'USD',bold:true}]
            ].concat(rows.filter(r=> (r.F && (r.F==="Guide Ticket" || r.F==="Guide Accommodation"))).map(r=>[ String(r.row), r.F, (r.G_local===""? "-" : fmt(r.G_local)), (r.G_usd===""? "-" : fmt(r.G_usd)) ]))
          }
        },
        { text: '\n', margin:[0,6] },
        { text: 'Subtotals (USD)', style: 'sectionTitle' },
        {
          table: {
            widths: ['*','auto'],
            body: [
              ['Accommodation subtotal (USD)', fmt(subs.accommodation)],
              ['Sites subtotal (USD)', fmt(subs.sites_usd)],
              ['Transfers subtotal (USD, per pax)', fmt(subs.transfers_usd)],
              ['Meals subtotal (USD)', fmt(subs.meals_usd)],
              ['Guide subtotal (USD)', fmt(subs.guide_usd)],
              [{ text: 'Single Supplement (70% of accommodation) (USD)', bold:true }, { text: fmt(roundTo(subs.accommodation * 0.7,2)), bold:true }],
              [{ text: 'Grand total (USD)', bold:true }, { text: fmt(appState.preview.summaryTotal), bold:true }]
            ]
          }
        },
        { text: '\nThank you — generated by Quotation Builder', style: 'muted', margin:[0,8,0,0] }
      ],
      styles: {
        header: { fontSize:18, bold:true, margin:[0,0,0,6] },
        subheader: { fontSize:12, margin:[0,0,0,6] },
        sectionTitle: { fontSize:13, bold:true, margin:[0,6,0,6] },
        muted: { fontSize:10, color:'#666' }
      }
    };

    pdfMake.createPdf(docDef).download((appState.quotationName || 'Quotation') + '.pdf');
  });

  // ---------- initial small helper ----------
  (function init(){ /* Intentionally minimal */ })();

  </script>
</body>
</html>
