<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quotation Builder — Client-only (preserve template & formatting)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f4f4f9; --fg:#222; --muted:#666; --card:#fff; --pri:#0b5fff; --pri-d:#0848c7; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; background:var(--bg); color:var(--fg); }
    .container { max-width:1100px; margin:28px auto; padding:20px; background:var(--card); border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.06); }
    h1 { margin:0 0 8px; font-size:22px; }
    .sub { color:var(--muted); margin-bottom:16px; font-size:13px; }
    .steps { display:flex; gap:8px; margin-bottom:14px; }
    .pill { padding:6px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px; }
    .step { display:none; }
    .step.active { display:block; }
    .grid { display:grid; gap:12px; }
    .cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .card { padding:12px; border:1px solid #eee; border-radius:10px; background:#fff; }
    .card h3 { margin:0 0 10px; font-size:15px; }
    label { display:block; margin:6px 0; font-size:13px; }
    input[type="text"], select { width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:8px; font-size:13px; }
    input[type="file"] { padding:8px; border:1px dashed #ccc; border-radius:8px; background:#fafafa; width:100%; }
    .row { display:flex; gap:10px; align-items:center; }
    .row > * { flex:1; }
    .buttons { display:flex; justify-content:space-between; gap:8px; margin-top:12px; }
    button { appearance:none; border:none; background:var(--pri); color:#fff; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; }
    button.secondary { background:#eef0f3; color:#111; }
    button:hover { background:var(--pri-d); }
    button.secondary:hover { background:#e0e3e7; }
    .hint { color:var(--muted); font-size:12px; margin-top:6px; }
    .stack { display:flex; flex-direction:column; gap:8px; }
    .checks { max-height:220px; overflow:auto; border:1px solid #eee; padding:8px; border-radius:8px; background:#fafafa; }
    .checks label { display:flex; gap:8px; align-items:center; margin:4px 0; font-size:13px; }
  </style>

  <!-- xlsx-style (fork supporting cell styles). Using CDN to preserve & edit styles -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx-style@0.8.13/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container" id="app">
    <h1>Quotation Builder</h1>
    <div class="sub">Client-side remake of your ASP.NET flow. Upload your <b>newbasequotation.xlsx</b>, follow steps and Download — formatting preserved and basic styles applied to written cells.</div>

    <div class="steps">
      <span class="pill">1) Upload & Sites</span>
      <span class="pill">2) Accommodation</span>
      <span class="pill">3) Meals & Guides</span>
      <span class="pill">4) Trips & Export</span>
    </div>

    <!-- STEP 1 -->
    <section id="step1" class="step active">
      <div class="grid cols-2">
        <div class="card">
          <h3>Upload Excel (.xlsx)</h3>
          <input id="upload" type="file" accept=".xlsx" />
          <div class="hint">We'll write into the first worksheet. Existing formatting will be preserved when possible.</div>
        </div>

        <div class="card">
          <h3>Quotation Info</h3>
          <div class="stack">
            <label>Quotation Name<input id="quotationName" type="text" placeholder="e.g. Smith Family Tour" /></label>
            <label>Flight Ticket (number)<input id="flightTicket" type="text" inputmode="numeric" placeholder="e.g. 2" /></label>
          </div>
        </div>
      </div>

      <div style="margin-top:12px;" class="grid cols-2">
        <div class="card"><h3>Pyramids</h3><div id="cbPyramids" class="checks"></div></div>
        <div class="card"><h3>Sakkara</h3><div id="cbSakkara" class="checks"></div></div>
      </div>

      <div style="margin-top:12px;" class="grid cols-2">
        <div class="card"><h3>Cairo/Giza</h3><div id="cbCairoGiza" class="checks"></div></div>
        <div class="card"><h3>Alexandria/Behera</h3><div id="cbAlexBehera" class="checks"></div></div>
      </div>

      <div style="margin-top:12px;" class="grid cols-2">
        <div class="card"><h3>Kafr el Sheikh & Co</h3><div id="cbKafrEtAl" class="checks"></div></div>
        <div class="card"><h3>Luxor</h3><div id="cbLuxor" class="checks"></div></div>
      </div>

      <div style="margin-top:12px;" class="grid cols-2">
        <div class="card"><h3>Aswan</h3><div id="cbAswan" class="checks"></div></div>
        <div class="card"><h3>Sharm el Sheikh</h3><div id="cbSharm" class="checks"></div></div>
      </div>

      <div class="buttons">
        <button class="secondary" id="resetBtn1" type="button">Reset</button>
        <button id="toStep2" type="button">Next → Accommodation</button>
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="step2" class="step">
      <div class="grid cols-2">
        <div class="card">
          <h3>Cairo/Giza</h3>
          <div class="row">
            <label>Nights<select id="ddlNightsCairoGiza"></select></label>
            <label>Price/Night ($)<select id="ddlPriceCairoGiza"></select></label>
          </div>
        </div>

        <div class="card">
          <h3>Sharm el Sheikh</h3>
          <div class="row">
            <label>Nights<select id="ddlNightsSharm"></select></label>
            <label>Price/Night ($)<select id="ddlPriceSharm"></select></label>
          </div>
        </div>
      </div>

      <div style="margin-top:12px;" class="grid cols-2">
        <div class="card">
          <h3>Luxor</h3>
          <div class="row">
            <label>Nights<select id="ddlNightsLuxor"></select></label>
            <label>Price/Night ($)<select id="ddlPriceLuxor"></select></label>
          </div>
        </div>

        <div class="card">
          <h3>Aswan</h3>
          <div class="row">
            <label>Nights<select id="ddlNightsAswan"></select></label>
            <label>Price/Night ($)<select id="ddlPriceAswan"></select></label>
          </div>
        </div>
      </div>

      <div style="margin-top:12px;" class="grid cols-2">
        <div class="card">
          <h3>Hurghada</h3>
          <div class="row">
            <label>Nights<select id="ddlNightsHurghada"></select></label>
            <label>Price/Night ($)<select id="ddlPriceHurghada"></select></label>
          </div>
        </div>

        <div class="card">
          <h3>Nile Cruise</h3>
          <div class="row">
            <label>Nights<select id="ddlNightsNileCruise"></select></label>
            <label>Price/Night ($)<select id="ddlPriceNileCruise"></select></label>
          </div>
        </div>
      </div>

      <div class="buttons">
        <button class="secondary" id="back1" type="button">← Back</button>
        <button id="toStep3" type="button">Next → Meals & Guides</button>
      </div>
    </section>

    <!-- STEP 3 -->
    <section id="step3" class="step">
      <div class="grid cols-3">
        <div class="card">
          <h3>Guide Ticket</h3>
          <input id="TextBoxGuideTicket" type="text" inputmode="numeric" />
        </div>
        <div class="card">
          <h3>Guide Accommodation</h3>
          <input id="TextBoxGuideAccomodation" type="text" inputmode="numeric" />
        </div>
        <div class="card">
          <h3>Meals per Price Tier</h3>
          <div id="mealsSelects" class="stack"></div>
        </div>
      </div>

      <div class="buttons">
        <button class="secondary" id="back2" type="button">← Back</button>
        <button id="toStep4" type="button">Next → Trips & Export</button>
      </div>
    </section>

    <!-- STEP 4 -->
    <section id="step4" class="step">
      <div class="grid cols-3">
        <div class="card">
          <h3>Cairo/Giza Counters</h3>
          <label>Cairo apt<select id="Cairoapt"></select></label>
          <label>Cairo Full Day<select id="Cairofd"></select></label>
          <label>Cairo Night<select id="CairoNight"></select></label>
        </div>

        <div class="card"><h3>Cairo/Giza Trips</h3><div id="cbCairoGizaTrips" class="checks"></div></div>
        <div class="card"><h3>Sharm Trips</h3><div id="cbSharmTrips" class="checks"></div></div>
      </div>

      <div style="margin-top:12px;" class="grid cols-2">
        <div class="card"><h3>Luxor Trips</h3><div id="cbLuxorTrips" class="checks"></div></div>
        <div class="card"><h3>Aswan Trips</h3><div id="cbAswanTrips" class="checks"></div></div>
      </div>

      <div class="buttons">
        <button class="secondary" id="back3" type="button">← Back</button>
        <button id="downloadBtn" type="button">Download Quotation (.xlsx)</button>
      </div>
    </section>
  </div>

<script>
/* -------------------------
   Compact, complete client-only app
   - reads an uploaded .xlsx (first sheet)
   - collects UI inputs across 4 steps
   - writes to exact cells used by your ASP.NET app
     (F/G rows 10..40, H rows 10..40, B/C rows 10..15, J/K rows 10..20, L/M 12..13, B2 header)
   - uses xlsx-style to preserve existing styles when present,
     and applies small default styles for written cells when template lacks them.
   -------------------------*/

const appState = {
  workbook: null,
  quotationName: "",
  flightTicket: "",
  sites: [],
  accommodation: {
    "Cairo/Giza": { nights: "0", price: "0" },
    "Sharm el Sheikh": { nights: "0", price: "0" },
    "Luxor": { nights: "0", price: "0" },
    "Aswan": { nights: "0", price: "0" },
    "Hurghada": { nights: "0", price: "0" },
    "Nile Cruise": { nights: "0", price: "0" }
  },
  guideTicket: "",
  guideAccomodation: "",
  meals: { "300":"0","400":"0","500":"0","600":"0","700":"0","800":"0","900":"0","1000":"0","1500":"0","2000":"0" },
  cairoCounters: { apt:"0", fd:"0", night:"0" },
  trips: { CairoGiza: [], Sharm: [], Luxor: [], Aswan: [] }
};

const lists = {
  Pyramids: ["Pyramids","Khufu Pyramid","Khafra Pyramid","Menkaure Pyramid","Grave of Mer As Ankh"],
  Sakkara: ["Memphis","Sakkara","Nobles Cemetery","South Cemetery","All Sakkara","Zoser Pyramid (Inside)","Serapeum Sakkara","Mereruka"],
  CairoGiza: ["Citadel","Egyptian Museum","Civilization Museum","Egyptian Museum (Guide)","Islamic Art Museum","Coptic Museum","Royal Carriage Museum","Gayer Anderson Museum","Senosert Obelisk","Baron Palace","Moez Street","Mohammed Ali Manial Palace","Nilometer","Rifa'i Mosque","Suhaymi House","Mohamed Ali Palace"],
  AlexBehera: ["Qaitbay","Montazah","Alexandria Library","Kom al Shuqafa","Kom al Dekka","Serapeum Alexandria","Alexandria Museum","Royal Jewellery Museum","Graeco-Roman Museum","Rashid City"],
  KafrEtAl: ["Abydoss","Dandara","Kafr El Sheikh Museum","San Al Hajar","Malwi Museum","Tona El Gabal","Bani Hassan Cemetery","Tal Al Omrana","Royal Cemetery Al Omrama","Meret Amon/Ramses II Statue"],
  Luxor: ["Karnak","Luxor Museum","Hot Air Balloon","Luxor Temple","Valley of Kings","Seti I Cemetery","Ay Cemetery","Hatshepsut","Der Al Madina","Pashtu Cemetery","Ra'muza Cemetery","Alramseum Temple","Abdel Karna","Carter House","Menena Nakht","Seti I Temple","Osraht - Khensu","ElAssassif","Esna","Tutankhamun Cemetery","Ramses VI","Habo","Valley of Queens","Nefertari","Khokha","Shuroy","Qurnet Murai","Abdel Karna Necropolis","Mummification","Mut (Karnak)"],
  Aswan: ["Abu Simbel","Unfinished Obelisk","Philae","Edfu","Kom Ombo","Nubian Museum","High Dam","Qubet Al Hawa","Al Kalabsha","AlKab","Abu Simbel Celebration"],
  Sharm: ["Parasailing","Jet Ski","Banana Boat","King tut Mus","Submarine","St Catherine","Neverland without dinner","Neverland with dinner","Dolphin","Sea Trip","Dinner Cruise","Quad Bike","Sharm Museum"],
  CairoGizaTrips: ["Cairo hd","Cairo fd October","Cairo apt + fd","Cairo open day","Alex fd","Ain sukhna","Cairo apt October","Sphinx apt","Sphinx apt fd","New capital apt","New capital apt fd","Quick Alex","Quick Sukhna","Minya","Oasis","Fayoum","Wadi Rayan","Zafarana","Farafra","Hurghada","Matrouh","Ras Sedr","Sharm","Dahab","Luxor","Aswan","On"],
  SharmTrips: ["Dep SSH","Arr SSH","Transfer Hotel SSH","City Tour SSH","City Tour SSH","City Tour SSH","City Tour SSH","City Tour SSH","Dep + Arr APT Cairo - SSH","Ras Mohamed Half Day ( SSH )","Ras Mohamed Full Day ( SSH )","St Catherine","St Catherine Moses","Cairo One Way ( SSH )","Orientation Dahab Full Day (Vehicle From Dahab)","Orientation Dahab Half Day (Vehicle From Dahab)","Dahab Jeep Safari ( SSH )","DAHAB ZAVYOT - SSH","Dahab ( Nuweiba ) Adventure"],
  LuxorTrips: ["Luxor Station","East","West Fd","West","Dandara","Dandara Abydoss","Hurghada Luxor","Luxor apt"],
  AswanTrips: ["Aswan Station","Aswan apt","Aswan fd","Nubian Museum","Abu Simbel","Nubian Village","Nubian Village Visit"]
};

const mealTiers = ["300","400","500","600","700","800","900","1000","1500","2000"];

function $q(s){ return document.querySelector(s); }
function renderChecks(containerId, arr){
  const wrap = document.getElementById(containerId);
  wrap.innerHTML = "";
  arr.forEach(t=>{
    const id = containerId + "_" + t.replace(/\W+/g,'_');
    const lab = document.createElement("label");
    const cb = document.createElement("input");
    cb.type = "checkbox"; cb.value = t; cb.id = id;
    lab.appendChild(cb);
    lab.appendChild(document.createTextNode(" " + t));
    wrap.appendChild(lab);
  });
}
function getChecked(containerId){
  return Array.from(document.querySelectorAll(`#${containerId} input[type=checkbox]:checked`)).map(i=>i.value);
}
function fillSelectRange(el, from, to){
  el.innerHTML = "";
  for(let i=from;i<=to;i++){ const o=document.createElement("option"); o.value=i; o.text=i; el.appendChild(o); }
}
function fillPriceList(el, arr){
  el.innerHTML=""; arr.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.text=v; el.appendChild(o); });
}

/* render controls */
renderChecks("cbPyramids", lists.Pyramids);
renderChecks("cbSakkara", lists.Sakkara);
renderChecks("cbCairoGiza", lists.CairoGiza);
renderChecks("cbAlexBehera", lists.AlexBehera);
renderChecks("cbKafrEtAl", lists.KafrEtAl);
renderChecks("cbLuxor", lists.Luxor);
renderChecks("cbAswan", lists.Aswan);
renderChecks("cbSharm", lists.Sharm);

renderChecks("cbCairoGizaTrips", lists.CairoGizaTrips);
renderChecks("cbSharmTrips", lists.SharmTrips);
renderChecks("cbLuxorTrips", lists.LuxorTrips);
renderChecks("cbAswanTrips", lists.AswanTrips);

/* fills for selects */
["ddlNightsCairoGiza","ddlNightsSharm","ddlNightsLuxor","ddlNightsAswan","ddlNightsHurghada","ddlNightsNileCruise"].forEach(id=>{
  fillSelectRange(document.getElementById(id), 0, 10);
});
[ "Cairoapt","Cairofd","CairoNight"].forEach(id=> fillSelectRange(document.getElementById(id), 0, 5) );

const price30to150 = [0,30,40,50,60,70,80,90,100,110,120,130,140,150,200,250];
const priceNile = [0,100,110,120,130,140,150,160,170,180,190,200,210,220,230,240,250,300,350,400];
fillPriceList(document.getElementById("ddlPriceCairoGiza"), price30to150);
fillPriceList(document.getElementById("ddlPriceSharm"), price30to150);
fillPriceList(document.getElementById("ddlPriceLuxor"), price30to150);
fillPriceList(document.getElementById("ddlPriceAswan"), price30to150);
fillPriceList(document.getElementById("ddlPriceHurghada"), price30to150);
fillPriceList(document.getElementById("ddlPriceNileCruise"), priceNile);

/* meals selects */
const mealsWrap = document.getElementById("mealsSelects");
mealTiers.forEach(t=>{
  const row = document.createElement("div"); row.className="row";
  const lbl = document.createElement("label"); lbl.textContent = `${t} Meals`;
  const sel = document.createElement("select"); sel.id = "ddlMeals"+t;
  fillSelectRange(sel,0,6);
  row.appendChild(lbl); row.appendChild(sel);
  mealsWrap.appendChild(row);
});

/* --- Upload excel --- */
$q("#upload").addEventListener("change", (e)=>{
  const f = e.target.files[0];
  if(!f){ alert("Choose a .xlsx file"); return; }
  const reader = new FileReader();
  reader.onload = ev=>{
    try{
      const data = new Uint8Array(ev.target.result);
      // read with cellStyles true to keep formatting
      appState.workbook = XLSX.read(data, { type: "array", cellStyles: true });
      alert("Excel uploaded and parsed.");
      console.log("Workbook sheets:", appState.workbook.SheetNames);
    }catch(err){
      console.error(err);
      alert("Failed to read workbook. Is it a valid .xlsx?");
    }
  };
  reader.readAsArrayBuffer(f);
});

/* --- navigation --- */
function showStep(n){ document.querySelectorAll(".step").forEach(s=>s.classList.remove("active")); $q("#step"+n).classList.add("active"); }
$q("#toStep2").addEventListener("click", ()=>{
  if(!appState.workbook){ alert("Upload an Excel (.xlsx) file first."); return; }
  const qn = $q("#quotationName").value.trim();
  if(!qn){ alert("Please provide a Quotation Name."); return; }
  appState.quotationName = qn;
  appState.flightTicket = $q("#flightTicket").value.trim();
  // collect sites
  appState.sites = [].concat(
    getChecked("cbPyramids"),
    getChecked("cbSakkara"),
    getChecked("cbCairoGiza"),
    getChecked("cbAlexBehera"),
    getChecked("cbKafrEtAl"),
    getChecked("cbLuxor"),
    getChecked("cbAswan"),
    getChecked("cbSharm")
  );
  showStep(2);
});
$q("#back1").addEventListener("click", ()=> showStep(1));
$q("#toStep3").addEventListener("click", ()=>{
  // collect accommodation
  appState.accommodation["Cairo/Giza"].nights = $q("#ddlNightsCairoGiza").value;
  appState.accommodation["Cairo/Giza"].price  = $q("#ddlPriceCairoGiza").value;
  appState.accommodation["Sharm el Sheikh"].nights = $q("#ddlNightsSharm").value;
  appState.accommodation["Sharm el Sheikh"].price  = $q("#ddlPriceSharm").value;
  appState.accommodation["Luxor"].nights = $q("#ddlNightsLuxor").value;
  appState.accommodation["Luxor"].price  = $q("#ddlPriceLuxor").value;
  appState.accommodation["Aswan"].nights = $q("#ddlNightsAswan").value;
  appState.accommodation["Aswan"].price  = $q("#ddlPriceAswan").value;
  appState.accommodation["Hurghada"].nights = $q("#ddlNightsHurghada").value;
  appState.accommodation["Hurghada"].price  = $q("#ddlPriceHurghada").value;
  appState.accommodation["Nile Cruise"].nights = $q("#ddlNightsNileCruise").value;
  appState.accommodation["Nile Cruise"].price  = $q("#ddlPriceNileCruise").value;
  showStep(3);
});
$q("#back2").addEventListener("click", ()=> showStep(2));
$q("#toStep4").addEventListener("click", ()=>{
  appState.guideTicket = $q("#TextBoxGuideTicket").value.trim();
  appState.guideAccomodation = $q("#TextBoxGuideAccomodation").value.trim();
  mealTiers.forEach(t => appState.meals[t] = $q("#ddlMeals"+t).value);
  showStep(4);
});
$q("#back3").addEventListener("click", ()=> showStep(3));
$q("#resetBtn1").addEventListener("click", ()=> { if(confirm("Clear all inputs and reload?")) location.reload(); });

/* tiny helpers for excel */
function toInt(v){ const x=parseInt(v,10); return Number.isFinite(x) ? x : null; }
function ensureRange(ws, minA1, maxA1){
  const dec = r=>XLSX.utils.decode_cell(r);
  const min = dec(minA1), max = dec(maxA1);
  const cur = ws['!ref'] ? XLSX.utils.decode_range(ws['!ref']) : { s:{c:0,r:0}, e:{c:0,r:0} };
  const s = { c: Math.min(cur.s.c, min.c), r: Math.min(cur.s.r, min.r) };
  const e = { c: Math.max(cur.e.c, max.c), r: Math.max(cur.e.r, max.r) };
  ws['!ref'] = XLSX.utils.encode_range({s,e});
}

/* default small styles to apply only when template cell has no style */
const defaultStyles = {
  header: { font:{name:"Calibri", sz:11, bold:true, color:{rgb:"0B3D91"}}, alignment:{horizontal:"left", vertical:"center"}, fill:{fgColor:{rgb:"EAF2FF"}} },
  label: { font:{name:"Calibri", sz:10, bold:false, color:{rgb:"000000"}}, alignment:{horizontal:"left", vertical:"center"} },
  number: { font:{name:"Calibri", sz:10}, alignment:{horizontal:"right", vertical:"center"} }
};

/* set cell - preserves existing style if exists, otherwise apply defaultStyleName */
function setCell(ws, a1, value, defaultStyleName){
  if(!ws[a1]) ws[a1] = {};
  // set type & value
  if(typeof value === "number" || (typeof value === "string" && /^\s*-?\d+(\.\d+)?\s*$/.test(value))){
    const num = typeof value === "number" ? value : Number(value);
    if(Number.isFinite(num)){ ws[a1].t = 'n'; ws[a1].v = num; }
    else { ws[a1].t = 's'; ws[a1].v = String(value); }
  } else {
    ws[a1].t = 's';
    ws[a1].v = (value === null || value === undefined) ? "" : String(value);
  }
  // preserve style if exists, else apply default
  if(ws[a1].s == null && defaultStyleName && defaultStyles[defaultStyleName]){
    ws[a1].s = JSON.parse(JSON.stringify(defaultStyles[defaultStyleName]));
    // if number style and numeric cell, apply a simple number format for currency-like fields
    if(defaultStyleName === "number" && ws[a1].t === 'n'){
      ws[a1].z = '$#,##0.00';
    }
  }
}

/* main writer - mirrors your C# placements exactly */
function writeExcelAndDownload(){
  if(!appState.workbook){ alert("No workbook loaded."); return; }
  const sheetName = appState.workbook.SheetNames[0];
  const ws = appState.workbook.Sheets[sheetName];
  if(!ws){ alert("Worksheet not found."); return; }

  // put quotation name in B2
  if(appState.quotationName) setCell(ws, 'B2', appState.quotationName, 'header');

  // Flight ticket + Sites (F/G rows 10..40)
  let rowF = 10;
  const ft = toInt(appState.flightTicket);
  if(ft !== null){
    setCell(ws, `F${rowF}`, "Flight Ticket", 'label');
    setCell(ws, `G${rowF}`, ft, 'number');
    rowF++;
  }
  for(const s of appState.sites){
    if(rowF > 40) break;
    setCell(ws, `F${rowF}`, s, 'label');
    rowF++;
  }

  // Guide extras (L12/M12 / L13/M13)
  const gTicket = toInt(appState.guideTicket);
  if(gTicket !== null){ setCell(ws, 'L12', "Guide Ticket", 'label'); setCell(ws, 'M12', gTicket, 'number'); }
  const gAcc = toInt(appState.guideAccomodation);
  if(gAcc !== null){ setCell(ws, 'L13', "GuideAccomodation", 'label'); setCell(ws, 'M13', gAcc, 'number'); }

  // Trips Column H rows 10..40
  let rowH = 10;
  const addH = txt => { if(rowH <= 40) { setCell(ws, `H${rowH}`, txt, 'label'); rowH++; } };
  const cntA = toInt(appState.cairoCounters.apt) || 0;
  for(let i=0;i<cntA;i++) addH("Cairo apt");
  const cntFd = toInt(appState.cairoCounters.fd) || 0;
  for(let i=0;i<cntFd;i++) addH("Cairo fd");
  const cntN = toInt(appState.cairoCounters.night) || 0;
  for(let i=0;i<cntN;i++) addH("Cairo night");
  // then checked trip items
  [...appState.trips.CairoGiza, ...appState.trips.Sharm, ...appState.trips.Luxor, ...appState.trips.Aswan].forEach(t => addH(t));

  // Accommodation B10:C15
  function fillAccommodation(place, nights, price, row){
    const ni = toInt(nights) || 0;
    const pi = toInt(price) || 0;
    if(ni>0 && pi>0){
      setCell(ws, `B${row}`, `${ni} nights ${place}`, 'label');
      setCell(ws, `C${row}`, ni * pi, 'number');
    } else {
      setCell(ws, `B${row}`, "", 'label');
      setCell(ws, `C${row}`, "", 'label');
    }
  }
  fillAccommodation("Cairo/Giza", appState.accommodation["Cairo/Giza"].nights, appState.accommodation["Cairo/Giza"].price, 10);
  fillAccommodation("Sharm el Sheikh", appState.accommodation["Sharm el Sheikh"].nights, appState.accommodation["Sharm el Sheikh"].price, 11);
  fillAccommodation("Luxor", appState.accommodation["Luxor"].nights, appState.accommodation["Luxor"].price, 12);
  fillAccommodation("Aswan", appState.accommodation["Aswan"].nights, appState.accommodation["Aswan"].price, 13);
  fillAccommodation("Hurghada", appState.accommodation["Hurghada"].nights, appState.accommodation["Hurghada"].price, 14);
  fillAccommodation("Nile Cruise", appState.accommodation["Nile Cruise"].nights, appState.accommodation["Nile Cruise"].price, 15);

  // Meals J10/K10 downward; K rows cleared to 20
  let rowJ=10, rowK=10;
  mealTiers.forEach(tier=>{
    const q = toInt(appState.meals[tier]) || 0;
    if(q > 0){
      setCell(ws, `J${rowJ}`, `${q} ${tier} meals`, 'label');
      setCell(ws, `K${rowK}`, q * toInt(tier), 'number');
      rowJ++; rowK++;
    }
  });
  for(let r=rowK; r<=20; r++) setCell(ws, `K${r}`, "", 'label');

  // ensure reference includes our writes
  ensureRange(ws, 'A1', 'M40');

  // write and download via xlsx-style (preserve cell styles)
  try{
    const wbout = XLSX.write(appState.workbook, { bookType: 'xlsx', type: 'array', cellStyles: true });
    const blob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = (appState.quotationName || "Quotation") + ".xlsx";
    document.body.appendChild(a);
    a.click();
    a.remove();
  }catch(err){
    console.error("Export failed:", err);
    alert("Export failed (check console).");
  }
}

/* collect trips & counters, then download */
$q("#downloadBtn").addEventListener("click", ()=>{
  // counters
  appState.cairoCounters.apt   = $q("#Cairoapt").value;
  appState.cairoCounters.fd    = $q("#Cairofd").value;
  appState.cairoCounters.night = $q("#CairoNight").value;

  // trips checkboxes
  appState.trips.CairoGiza = getChecked("cbCairoGizaTrips");
  appState.trips.Sharm     = getChecked("cbSharmTrips");
  appState.trips.Luxor     = getChecked("cbLuxorTrips");
  appState.trips.Aswan     = getChecked("cbAswanTrips");

  // ensure quotation name up to date
  const qn = $q("#quotationName").value.trim();
  if(qn) appState.quotationName = qn;

  // quick validations
  if(!appState.workbook){ alert("Upload the base .xlsx file first."); return; }
  if(!appState.quotationName){ alert("Please fill Quotation Name before download."); return; }

  writeExcelAndDownload();
});

/* update appState.trips when user toggles checkboxes in Step4 (optional) */
["cbCairoGizaTrips","cbSharmTrips","cbLuxorTrips","cbAswanTrips"].forEach(id=>{
  document.getElementById(id).addEventListener("change", ()=> {
    // keep appState in sync immediately (optional)
  });
});

/* quick console message for debugging */
console.log("Quotation builder ready.");
</script>
</body>
</html>
